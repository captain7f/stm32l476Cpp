/*
 * UART_Hal.h
 *
 *  Created on: Oct 30, 2025
 *      Author: FA
 */

#ifndef INC_UART_HAL_H_
#define INC_UART_HAL_H_

//-------includes------------
#include "main.h"
#include "usart.h"

#include "ISR_Hal.h"
#include "CircularBuffer.h"
//-------defines------------
#define UART_COUNT (1)
#define RX_SIZE_BUFFER (64)

#ifndef UART_ISR_MAX
  #define UART_ISR_MAX (2)
#endif

// ------------- UartBase -------------
class UartBase{
public:
	UartBase(USART_TypeDef* Instance, UART_HandleTypeDef* huart);
	~UartBase();

	void init();
	HAL_StatusTypeDef write(uint8_t* pData, uint16_t Size, uint32_t Timeout =1000);
protected:
	USART_TypeDef* _Instance;
	UART_HandleTypeDef* _huart;
private:
	static bool  isInit[UART_COUNT];
};



// ------------- UartIT -------------


class UartIT: public UartBase{
public:
	UartIT(USART_TypeDef* Instance, UART_HandleTypeDef* huart);
	~UartIT();

	HAL_StatusTypeDef write(uint8_t *pData, uint16_t Size);
	HAL_StatusTypeDef start_read(void);
	uint16_t read(uint8_t *pData, uint16_t Size);
protected:
	bool _is_tx_done;
	uint8_t _read_buffer[RX_SIZE_BUFFER];
	CircularBuffer<uint8_t> *_buffer;
	static ISR<UartIT, UART_ISR_MAX> ISR_LIST;
private:
	static void TxCpltCallback(UART_HandleTypeDef* huart);
	static void RxEventCallback(UART_HandleTypeDef* huart, uint16_t Pos);
	void put(uint16_t index, uint16_t size);
};


#endif /* INC_UART_HAL_H_ */
